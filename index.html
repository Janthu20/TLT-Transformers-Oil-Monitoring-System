<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Tank System</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    
    <style>
        :root { 
            --bg-deep: #0b0e14;
            --card-bg: #161b22;
            --navy-accent: #1f2937;
            --neon-blue: #0ea5e9;
            --neon-green: #10b981;
            --text-main: #f9fafb;
            --text-dim: #9ca3af;
            --danger: #ef4444; 
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-deep); margin: 0; padding: 0; color: var(--text-main); }
        .hidden { display: none !important; }
        
        #loading-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-deep); display: flex; justify-content: center; 
            align-items: center; z-index: 9999; color: var(--neon-blue); font-weight: bold;
            text-align: center; padding: 20px;
        }

        /* Top Navbar - Title Only */
        .navbar { 
            background: #000000; color: var(--text-main); padding: 18px 20px; 
            text-align: center; border-bottom: 1px solid #30363d; 
            position: sticky; top: 0; z-index: 1000;
        }
        .nav-title { margin:0; cursor:pointer; font-weight: bold; letter-spacing: 1px; font-size: 1.2rem; }
        .nav-title:hover { color: var(--neon-blue); }

        /* NEW: Fixed Bottom Navigation Bar */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #000000; border-top: 1px solid #30363d;
            display: flex; justify-content: space-around; align-items: center;
            padding: 12px 0; z-index: 1000;
        }
        .bottom-nav button {
            flex: 0.45; padding: 12px; border-radius: 10px; font-size: 0.9rem;
            font-weight: bold; cursor: pointer; transition: 0.3s;
        }

        .container { padding: 20px; max-width: 1400px; margin: auto; padding-bottom: 100px; /* Space for bottom nav */ }
        
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .summary-card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid #30363d; position: relative; overflow: hidden; }
        .summary-card::before { content: ""; position: absolute; left: 0; top: 0; height: 100%; width: 4px; background: var(--neon-green); }
        .val-large { font-size: 2rem; font-weight: 800; color: var(--text-main); margin: 10px 0; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .tank-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border: 1px solid #30363d; transition: 0.3s ease; }
        
        .level-container { width: 100%; height: 12px; background: #0d1117; border-radius: 6px; margin: 20px 0; overflow: hidden; }
        .level-bar { height: 100%; background: linear-gradient(90deg, var(--neon-green) 0%, var(--neon-blue) 100%); transition: width 1s ease-in-out; }
        
        .full-center { display: flex; justify-content: center; align-items: center; min-height: 80vh; padding: 15px; }
        .login-card { background: var(--card-bg); padding: 30px; border-radius: 20px; border: 1px solid #30363d; width: 100%; max-width: 400px; text-align: center; }
        
        .input-group { position: relative; width: 100%; margin: 12px 0; }
        input { width: 100%; padding: 14px; background: #0d1117; border: 1px solid #30363d; border-radius: 8px; color: #fff; font-size: 16px; box-sizing: border-box; outline: none; }
        .toggle-btn { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-dim); }
        
        .btn-primary { background: var(--neon-blue); color: #fff; border: none; }
        .btn-logout { background: var(--danger); color: #fff; border: none; }
        .btn-cal { background: var(--navy-accent); color: #fff; border: 1px solid #30363d; }
        .btn-outline { background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); }
        
        .footer { margin-top: 40px; text-align: center; color: var(--text-dim); font-size: 13px; line-height: 1.8; border-top: 1px solid #30363d; padding: 25px 10px; }
        .footer a { color: var(--neon-blue); text-decoration: none; }
    </style>
</head>
<body>

    <div id="loading-screen">SECURE CONNECTION INITIALIZING...</div>

    <div id="login-section" class="full-center hidden" style="height: 100vh; background: #000;">
        <div class="login-card">
            <h2 style="color: var(--neon-blue); margin-top: 0;">TANK LOGIN</h2>
            <p style="color: var(--text-dim); margin-bottom: 25px;">Authorized Access Only</p>
            <input type="email" id="email" placeholder="Email Address">
            <div class="input-group">
                <input type="password" id="password" placeholder="Password">
                <span class="toggle-btn" onclick="togglePass('password')">üëÅÔ∏è</span>
            </div>
            <button onclick="handleLogin()" class="btn-primary" style="width:100%; margin-top:10px;">Access System</button>
            <p id="login-error" style="color:var(--danger); font-size:13px; margin-top:15px; display:none;"></p>
        </div>
    </div>

    <div id="main-app" class="hidden">
        <nav class="navbar">
            <h3 class="nav-title" onclick="showDashboard()">LIVE MONITORING PANEL</h3>
        </nav>

        <div class="container">
            <div id="dashboard-view">
                <div class="summary-grid">
                    <div class="summary-card"><h4>System Total Volume</h4><div class="val-large"><span id="total-vol">0</span> L</div></div>
                    <div class="summary-card" style="border-left-color: var(--neon-blue);"><h4>Average System Level</h4><div class="val-large"><span id="total-perc">0.0</span> %</div></div>
                </div>
                <div id="tanks-grid" class="grid"></div>
                
                <div class="footer">
                    <strong>Developer: Isuru Wijerathna</strong><br>
                    Contact: +94759054648 | +94714644412<br>
                    Email: <a href="mailto:xpisuru@gmail.com">xpisuru@gmail.com</a><br>
                    ¬© 2026 All Rights Reserved
                </div>
            </div>

            <div id="cal-auth-view" class="hidden">
                <div class="full-center">
                    <div class="login-card">
                        <h3 style="color: var(--neon-green);">ADMIN VERIFICATION</h3>
                        <p style="color: var(--text-dim);">Enter Calibration PIN</p>
                        <div class="input-group">
                            <input type="password" id="cal-pin" placeholder="PIN Code">
                            <span class="toggle-btn" onclick="togglePass('cal-pin')">üëÅÔ∏è</span>
                        </div>
                        <button onclick="verifyCalPassword()" class="btn-primary" style="width:100%; margin-top:10px;">Verify PIN</button>
                        <button onclick="showChangePasswordView()" class="btn-outline" style="width:100%; margin-top:10px;">Change PIN</button>
                        <button onclick="showDashboard()" style="background:transparent; color:var(--text-dim); margin-top:15px; width:100%;">Cancel</button>
                    </div>
                </div>
            </div>

            <div id="change-password-view" class="hidden">
                <div class="full-center">
                    <div class="login-card">
                        <h3 style="color: var(--neon-blue);">CHANGE PIN</h3>
                        <p style="color: var(--text-dim);">Update Access PIN</p>
                        <div class="input-group">
                            <input type="password" id="old-pin" placeholder="Old PIN">
                            <span class="toggle-btn" onclick="togglePass('old-pin')">üëÅÔ∏è</span>
                        </div>
                        <div class="input-group">
                            <input type="password" id="new-pin" placeholder="New PIN">
                            <span class="toggle-btn" onclick="togglePass('new-pin')">üëÅÔ∏è</span>
                        </div>
                        <div class="input-group">
                            <input type="password" id="confirm-new-pin" placeholder="Confirm New PIN">
                            <span class="toggle-btn" onclick="togglePass('confirm-new-pin')">üëÅÔ∏è</span>
                        </div>
                        <button onclick="updateCalPassword()" class="btn-primary" style="width:100%; margin-top:10px;">Save New PIN</button>
                        <button onclick="showCalAuth()" class="btn-outline" style="width:100%; margin-top:10px;">Back</button>
                    </div>
                </div>
            </div>

            <div id="selection-section" class="hidden">
                <div class="login-card" style="max-width: 600px; margin:auto">
                    <h3 style="color:var(--neon-blue)">SELECT TANK</h3>
                    <div class="grid" id="selection-grid" style="grid-template-columns: 1fr;"></div>
                    <button onclick="showDashboard()" style="background:var(--navy-accent); color:white; width:100%; margin-top:20px; border: 1px solid #30363d;">Back to Dashboard</button>
                </div>
            </div>

            <div id="wizard-section" class="hidden">
                <div class="login-card" style="max-width: 500px; margin:auto">
                    <h3 id="wizard-title" style="color:var(--neon-blue)">SETUP</h3>
                    <div id="step-1" class="wizard-step">
                        <input type="number" id="wiz-dia" placeholder="Diameter (mm)">
                        <input type="number" id="wiz-maxh" placeholder="Full Height (mm)">
                    </div>
                    <div id="step-points" class="wizard-step hidden">
                        <p id="point-instruction" style="color:var(--neon-green)"></p>
                        <div style="font-size:40px; font-weight:bold; color:var(--neon-green); margin:15px 0;" id="live-raw">0</div>
                        <input type="number" id="wiz-h" placeholder="Current Height (mm)">
                    </div>
                    <div style="display:flex; justify-content: space-between; margin-top:20px; gap:10px;">
                        <button onclick="showDashboard()" style="background:#333; color:#fff; flex:1;">Cancel</button>
                        <button id="next-btn" onclick="nextStep()" class="btn-primary" style="flex:1;">Next</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-nav">
            <button onclick="showCalAuth()" class="btn-cal">Calibration</button>
            <button onclick="handleLogout()" class="btn-logout">Logout</button>
        </div>
    </div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyANwLrsXHB13XqH6xp4xv4vDyncxc5KIXM",
        authDomain: "esp32-tank-level-monitoring.firebaseapp.com",
        databaseURL: "https://esp32-tank-level-monitoring-default-rtdb.firebaseio.com",
        projectId: "esp32-tank-level-monitoring",
        storageBucket: "esp32-tank-level-monitoring.firebasestorage.app",
        messagingSenderId: "378866707020",
        appId: "1:378866707020:web:7e9f74f40707d50c5c62e9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();

    let currentCalPIN = "";

    auth.onAuthStateChanged(user => {
        document.getElementById('loading-screen').classList.add('hidden');
        if (user) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            fetchCalPassword();
            showDashboard();
            startDataListener();
        } else {
            document.getElementById('main-app').classList.add('hidden');
            document.getElementById('login-section').classList.remove('hidden');
        }
    });

    function togglePass(id) {
        const input = document.getElementById(id);
        const btn = input.nextElementSibling;
        if (input.type === "password") { input.type = "text"; btn.innerText = "üîí"; }
        else { input.type = "password"; btn.innerText = "üëÅÔ∏è"; }
    }

    function fetchCalPassword() {
        db.ref('AdminConfig/calPassword').on('value', snap => {
            currentCalPIN = snap.exists() ? snap.val() : "abcd1234";
        });
    }

    function hideAll() {
        ['dashboard-view', 'cal-auth-view', 'change-password-view', 'selection-section', 'wizard-section'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
    }

    function showDashboard() { hideAll(); document.getElementById('dashboard-view').classList.remove('hidden'); }
    function showCalAuth() { hideAll(); document.getElementById('cal-auth-view').classList.remove('hidden'); }
    function showChangePasswordView() { hideAll(); document.getElementById('change-password-view').classList.remove('hidden'); }

    function verifyCalPassword() {
        if (document.getElementById('cal-pin').value === currentCalPIN) {
            hideAll(); document.getElementById('selection-section').classList.remove('hidden'); loadSelectionGrid();
        } else alert("Incorrect PIN!");
    }

    function updateCalPassword() {
        const oldP = document.getElementById('old-pin').value;
        const newP = document.getElementById('new-pin').value;
        const confP = document.getElementById('confirm-new-pin').value;
        if (oldP !== currentCalPIN) return alert("Old PIN incorrect!");
        if (newP.length < 4) return alert("PIN too short!");
        if (newP !== confP) return alert("Mismatch!");
        db.ref('AdminConfig/calPassword').set(newP).then(() => { alert("PIN Updated!"); showCalAuth(); });
    }

    function handleLogin() {
        auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(err => {
            document.getElementById('login-error').innerText = err.message;
            document.getElementById('login-error').style.display = 'block';
        });
    }

    function handleLogout() { auth.signOut(); }

    function startDataListener() {
        db.ref('Tanks').on('value', snap => {
            const data = snap.val() || {};
            const grid = document.getElementById('tanks-grid');
            grid.innerHTML = "";
            let totalV = 0, totalMaxV = 0;

            for(let i=1; i<=4; i++) {
                const tank = data[`Tank${i}`] || { analog_raw: 0 };
                const config = tank.config || {};
                let vol = 0, perc = 0;

                if(config.isConfigured) {
                    let h = calculateHeight(tank.analog_raw, config);
                    let rawVol = (Math.PI * Math.pow(config.diameter/2, 2) * h) / 1000000;
                    vol = rawVol < 5 ? 0 : Math.round(rawVol / 5) * 5; 
                    perc = (h / config.max_height) * 100;
                    totalV += vol;
                    totalMaxV += (Math.PI * Math.pow(config.diameter/2, 2) * config.max_height) / 1000000;
                }

                grid.innerHTML += `
                    <div class="tank-card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <span style="font-weight:bold;">TANK 0${i}</span>
                            <small style="color:var(--neon-green)">SIG: ${tank.analog_raw}</small>
                        </div>
                        <div style="font-size:32px; font-weight:800; margin:15px 0;">${vol} L</div>
                        <div class="level-container"><div class="level-bar" style="width:${perc}%"></div></div>
                        <small style="color:var(--text-dim)">LEVEL: ${perc.toFixed(1)}% | T${i}</small>
                    </div>`;
            }
            document.getElementById('total-vol').innerText = totalV;
            document.getElementById('total-perc').innerText = totalMaxV > 0 ? ((totalV/totalMaxV)*100).toFixed(1) : "0.0";
        });
    }

    function calculateHeight(raw, c) {
        let h = (raw <= c.p2_raw) ? (c.p1_h + (raw - c.p1_raw) * (c.p2_h - c.p1_h) / (c.p2_raw - c.p1_raw || 1)) : (c.p2_h + (raw - c.p2_raw) * (c.p3_h - c.p2_h) / (c.p3_raw - c.p2_raw || 1));
        return Math.max(0, Math.min(h, c.max_height));
    }

    function loadSelectionGrid() {
        db.ref('Tanks').once('value', snap => {
            const data = snap.val() || {};
            const grid = document.getElementById('selection-grid');
            grid.innerHTML = "";
            for(let i=1; i<=4; i++) {
                const isSet = data[`Tank${i}`]?.config?.isConfigured;
                grid.innerHTML += `<div class="tank-card" onclick="startWizard(${i})" style="cursor:pointer; text-align:center; padding: 15px;">
                    <p style="margin: 0 0 10px 0; font-weight: bold;">TANK 0${i}</p>
                    <button class="btn-primary" style="width:100%; padding: 10px;">${isSet?'EDIT':'SETUP'}</button>
                </div>`;
            }
        });
    }

    let currentTankId = null, currentStep = 1, wizardData = {};
    function startWizard(id) {
        currentTankId = id; currentStep = 1; wizardData = { p1:{}, p2:{}, p3:{} };
        hideAll(); document.getElementById('wizard-section').classList.remove('hidden'); updateWizardUI();
    }

    function updateWizardUI() {
        document.getElementById('step-1').classList.add('hidden');
        document.getElementById('step-points').classList.add('hidden');
        const nextBtn = document.getElementById('next-btn');
        nextBtn.innerText = currentStep === 4 ? "FINISH" : "NEXT";
        if(currentStep === 1) {
            document.getElementById('step-1').classList.remove('hidden');
            document.getElementById('wizard-title').innerText = `TANK 0${currentTankId} SETUP`;
        } else {
            document.getElementById('step-points').classList.remove('hidden');
            document.getElementById('point-instruction').innerText = `POINT ${currentStep-1} CALIBRATION`;
            db.ref(`Tanks/Tank${currentTankId}/analog_raw`).on('value', snap => {
                document.getElementById('live-raw').innerText = snap.val() || 0;
            });
        }
    }

    function nextStep() {
        if(currentStep === 1) {
            wizardData.dia = parseFloat(document.getElementById('wiz-dia').value);
            wizardData.maxH = parseFloat(document.getElementById('wiz-maxh').value);
            if(!wizardData.dia || !wizardData.maxH) return alert("Fill parameters!");
            currentStep++; updateWizardUI();
        } else {
            const h = parseFloat(document.getElementById('wiz-h').value);
            if(isNaN(h) || h > wizardData.maxH) return alert("Invalid height!");
            wizardData[`p${currentStep-1}`] = { raw: parseInt(document.getElementById('live-raw').innerText), h: h };
            if(currentStep === 4) {
                const config = { diameter: wizardData.dia, max_height: wizardData.maxH, p1_raw: wizardData.p1.raw, p1_h: wizardData.p1.h, p2_raw: wizardData.p2.raw, p2_h: wizardData.p2.h, p3_raw: wizardData.p3.raw, p3_h: wizardData.p3.h, isConfigured: true };
                db.ref(`Tanks/Tank${currentTankId}/config`).set(config).then(() => { alert("Saved!"); showDashboard(); });
            } else { currentStep++; document.getElementById('wiz-h').value = ""; updateWizardUI(); }
        }
    }
</script>
</body>
</html>
